//@version=5
indicator("SMC Scanner [FVG + OB] â€“ by Keqing", overlay=true, max_boxes_count=500, max_lines_count=500)

type Zone
    box id
    bool is_bull
    float top
    float bottom
    int left
    bool is_ob

grp_fvg = "Fair Value Gaps"
fvg_extend_bars = input.int(5, "FVG Extension (Bars)", minval=1, group=grp_fvg)
fvg_bull_col = input.color(color.new(color.green, 70), "Bullish FVG Color", group=grp_fvg)
fvg_bear_col = input.color(color.new(color.red, 70), "Bearish FVG Color", group=grp_fvg)
fvg_min_size = input.float(0.0, "Min Gap Size (Pips/Points)", group=grp_fvg)
filter_mitigated = input.bool(true, "Hide Mitigated FVGs?", group=grp_fvg)

grp_ob = "Order Blocks"
ob_extend_bars = input.int(5, "OB Extension (Bars)", minval=1, group=grp_ob)
ob_bull_col = input.color(color.new(color.blue, 70), "Bullish OB Color", group=grp_ob)
ob_bear_col = input.color(color.new(color.orange, 70), "Bearish OB Color", group=grp_ob)
ob_lookback = input.int(20, "Avg Body Lookback", group=grp_ob)
ob_strength = input.float(1.5, "Momentum Multiplier", group=grp_ob)

grp_sett = "Settings"
show_table = input.bool(true, "Show Status Panel", group=grp_sett)
max_active_boxes = input.int(150, "Max Active Objects (per Type)", minval=10, maxval=250, group=grp_sett)

var Zone[] fvg_zones = array.new<Zone>()
var Zone[] ob_zones = array.new<Zone>()

body_size = math.abs(close - open)
avg_body = ta.sma(body_size, ob_lookback)

safe_hist = bar_index > 2

fvg_bull = safe_hist and high[2] < low
fvg_bear = safe_hist and low[2] > high

ob_bull_cond = safe_hist and close[1] < open[1] and close > open and close > high[1] and body_size > (avg_body * ob_strength)
ob_bear_cond = safe_hist and close[1] > open[1] and close < open and close < low[1] and body_size > (avg_body * ob_strength)

if array.size(fvg_zones) >= max_active_boxes
    oldest = array.shift(fvg_zones)
    box.delete(oldest.id)

if array.size(ob_zones) >= max_active_boxes
    oldest = array.shift(ob_zones)
    box.delete(oldest.id)

if fvg_bull
    top = low
    btm = high[2]
    if (top - btm) >= fvg_min_size
        right_idx = bar_index + fvg_extend_bars
        b = box.new(bar_index - 1, top, right_idx, btm, bgcolor=fvg_bull_col, border_width=0, xloc=xloc.bar_index)
        z = Zone.new(b, true, top, btm, bar_index - 1, false)
        array.push(fvg_zones, z)

if fvg_bear
    top = low[2]
    btm = high
    if (top - btm) >= fvg_min_size
        right_idx = bar_index + fvg_extend_bars
        b = box.new(bar_index - 1, top, right_idx, btm, bgcolor=fvg_bear_col, border_width=0, xloc=xloc.bar_index)
        z = Zone.new(b, false, top, btm, bar_index - 1, false)
        array.push(fvg_zones, z)

if ob_bull_cond
    top = high[1]
    btm = low[1]
    right_idx = bar_index + ob_extend_bars
    b = box.new(bar_index - 1, top, right_idx, btm, bgcolor=ob_bull_col, border_color=color.new(ob_bull_col, 50), extend=extend.none, text="OB+", text_color=color.gray, text_size=size.tiny, xloc=xloc.bar_index)
    z = Zone.new(b, true, top, btm, bar_index - 1, true)
    array.push(ob_zones, z)

if ob_bear_cond
    top = high[1]
    btm = low[1]
    right_idx = bar_index + ob_extend_bars
    b = box.new(bar_index - 1, top, right_idx, btm, bgcolor=ob_bear_col, border_color=color.new(ob_bear_col, 50), extend=extend.none, text="OB-", text_color=color.gray, text_size=size.tiny, xloc=xloc.bar_index)
    z = Zone.new(b, false, top, btm, bar_index - 1, true)
    array.push(ob_zones, z)

if array.size(fvg_zones) > 0
    int i = array.size(fvg_zones) - 1
    while i >= 0
        z = array.get(fvg_zones, i)
        expiration = z.left + fvg_extend_bars + 1
        if bar_index > expiration
            array.remove(fvg_zones, i)
            i := i - 1
            continue
        if filter_mitigated
            is_newly_created = (bar_index <= (z.left + 1))
            if not is_newly_created
                is_mitigated = (high >= z.bottom and low <= z.top)
                if is_mitigated
                    box.set_right(z.id, bar_index)
                    box.set_bgcolor(z.id, color.new(color.gray, 90))
                    array.remove(fvg_zones, i)
        i := i - 1

if array.size(ob_zones) > 0
    int i = array.size(ob_zones) - 1
    while i >= 0
        z = array.get(ob_zones, i)
        expiration = z.left + ob_extend_bars + 1
        if bar_index > expiration
            array.remove(ob_zones, i)
            i := i - 1
            continue
        bool invalid = false
        if z.is_bull and close < z.bottom
            invalid := true
        else if not z.is_bull and close > z.top
            invalid := true
        if invalid
            box.set_extend(z.id, extend.none)
            box.set_right(z.id, bar_index)
            box.set_bgcolor(z.id, color.new(color.gray, 85))
            box.set_border_style(z.id, line.style_dotted)
            array.remove(ob_zones, i)
        i := i - 1

var table status_tbl = table.new(position.bottom_right, 2, 3, bgcolor=color.new(color.black, 60), border_width=1)

if show_table and barstate.islast
    count_fvg = array.size(fvg_zones)
    count_ob = array.size(ob_zones)
    table.cell(status_tbl, 0, 0, "Scanner Status", text_color=color.white, bgcolor=color.new(color.blue, 60))
    table.cell(status_tbl, 1, 0, "Active", text_color=color.white, bgcolor=color.new(color.blue, 60))
    table.cell(status_tbl, 0, 1, "FVG", text_color=fvg_bull_col)
    table.cell(status_tbl, 1, 1, str.tostring(count_fvg), text_color=color.white)
    table.cell(status_tbl, 0, 2, "OB", text_color=ob_bull_col)
    table.cell(status_tbl, 1, 2, str.tostring(count_ob), text_color=color.white)
